<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>iD</title>
        <link rel='stylesheet' href='dist/iD.css'/>
        <meta name='viewport' content='initial-scale=1.0 maximum-scale=1.0'/>
        <meta name='apple-mobile-web-app-capable' content='yes'/>
        <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'/>
        <script src='dist/iD.js'></script>
    </head>
    <body>
        <div id='id-container'></div>
        <script>

        function start() {
            id = iD.Context()
                .assetPath('dist/');

            id.connection().projectId(projId).scenarioId(scId);

            id.ui()(document.getElementById('id-container'), function() {
                iD.d3.select('#about-list')
                    .insert('li', '.user-list')
                    .attr('class', 'source-switch')
                    .call(iD.uiSourceSwitch(id)
                        .keys([
                            {
                                'urlroot': 'https://www.openstreetmap.org',
                                'oauth_consumer_key': '5A043yRSEugj4DJ5TljuapfnrflWDte8jTOcWLlT',
                                'oauth_secret': 'aB3jKq1TRsCOUrfOIZ6oQMEDmv2ptV76PA54NGLL'
                            },
                            {
                                'urlroot': 'https://api06.dev.openstreetmap.org',
                                'oauth_consumer_key': 'zwQZFivccHkLs3a8Rq5CoS412fE5aPCXDw9DZj7R',
                                'oauth_secret': 'aMnOOCwExO2XYtRVWJ1bI9QOdqh1cay2UgpbhA6p'
                            }
                        ])
                    );
            });
        }

        function notifier (id, element) {
          let events = {};

          let _notifier = {
            on: (type, cb) => {
              if (!events[type]) events[type] = [];
              events[type].push(cb);
              return _notifier;
            },
            send: (type, data = {}) => {
              let msg = Object.assign({}, { id: id, type: type }, data);
              element.postMessage(msg, '*');
              return _notifier;
            }
          };

          window.addEventListener('message', e => {
            if (!e.data.type) return;
            let cbs = events[e.data.type] || [];
            cbs.forEach(cb => cb(e));
          });

          return _notifier;
        }

        var projId, scId;
        if (window === window.parent) {
            // alert('Not inside an iframe. Prompt for ids');
            // projId = parseInt(prompt('Insert project id'), 10);
            // scId = parseInt(prompt('Insert scenario id'), 10);
            projId = 2000;
            scId = 2000;
            start();
        } else {
            notifier('rra-editor', window.parent)
                .send('loaded')
                .on('settings', data => {
                    projId = data.projectId;
                    scId = data.scenarioId;
                    start();
                });
        }


        </script>
    </body>
</html>
